let ver="2.1.2";const {Worker:Woorker,isMainThread,parentPort,workerData}=require("node:worker_threads");var wexec=(h="help",...k)=>new Promise((e,f)=>{const d=new Woorker(require.resolve(process.argv[1]),{workerData:[h,k]});d.on("message",e);d.on("error",f);d.on("exit",a=>{0!==a&&f(Error(`${h} stopped with exit code ${a}`))})});
if(isMainThread){process.stdout.write("\u001bc");const {spawn:h}=require("child_process"),k=require("fs"),e=require("repl");var installedDeps=[],lastConsoleFrom,kills=[],installing=[],lastErrorTime={},npm={installing:[],install:(a,l,c)=>{npm.installing.push(a);require("child_process").exec((l?"cd "+l+"&&":"")+"npm i "+a+" "+c,b=>{npm.installing[npm.installing.findIndex(g=>g==a)]=void 0;b&&process.stdout.write(b)})}};let f=()=>{console.log("MultiBot by 5UP3R_D1N\n\nHelp you cheat host multiple bots in 1 host! >:D\n\nCommands :\nbots : display bots or interact with bot\n - bots['BOTNAME'].restart : Restart the bot\n - bots['BOTNAME'].terminate : Terminate the bot\n - bots['BOTNAME'].raw : View raw child_process data, Do not modify directly!\nnewbot(folder_name) : Spawn new bot.\nnpm : Parralel npm port to this REPL\n - npm.install(pkg, cwd, opt) : Install new package, more options soon.\n - npm.installing : See whats installing\ncheckUpdate() : Check for update, this is automatic, require manual restart.\nwexec('FN_NAME',args...) : Experimental, Execute specific worker.\n\nHow to use :\nSimply put bot folder in this folder, as many folders as you want, it will automatically detect and start.\n\nFeatures :\nBOTNAME: TEXT : Send TEXT to BOTNAME's stdin.\n")};
var checkUpdate=(a=!1)=>{const l=require("https"),c=require("fs"),b=require("url");require("child_process");a||console.log("Checking for update...");l.get(b.parse("https://raw.githubusercontent.com/superdin-inc/MultiBot/main/built.js"),g=>{var m="";g.setEncoding("utf8").on("data",n=>m+=n).on("end",()=>{if(Buffer.from(m).length!=c.readFileSync(require.resolve(process.argv[1])).length){console.log("Updating...");try{c.writeFileSync(require.resolve(process.argv[1]),Buffer.from(m)),process.stdout.write("Please restart manually to apply update!")}catch(n){console.log("Failed to apply new update : "+
n)}}else a||console.log("No update found!")}).on("error",n=>{console.log("Failed to check for update.");throw n;})})},bots={};const d=/Error: Cannot find module '([a-z0-9@][a-z0-9@\/._-]{0,214})'/m;var newbot=a=>{console.log("Starting "+a+"...");let l=c=>{installing.includes(a)||(kills.includes(a)&&(kills[kills.findIndex(b=>b==a)]=void 0),6E4>Date.now()-lastErrorTime[a]?console.log(a+" crashed multiple times within 60 seconds, stopping..."):(console.log(a+" closed unexpectedly, restarting in 5 seconds"),
setTimeout(b=>newbot(a),5E3),lastErrorTime[a]=Date.now()))};try{let c=h(process.argv[0],[require.resolve("./"+(a+"/"+require("./"+a+"/package.json").main).match(/\/{0,1}(.+)\/{0,1}/m)[1])],{cwd:process.cwd()+"/"+a,env:{...process.env,FORCE_COLOR:!0}});c.stdout.on("data",b=>{lastConsoleFrom!=a&&console.log(" <----- "+a+" -----\x3e");process.stdout.write(b);lastConsoleFrom=a});c.stderr.on("data",b=>{let g=b.toString("utf-8").match(d);if(null!=g){console.log('Error: Dependency "'+g[1]+'" not found, required by '+
a+"\n  -- installing in background...");if(installedDeps.includes(g[1]))return console.error("Error: Already installed this dependency previously.\n  -- Stopping due to suspected failed install.\n  -- Please check that the bot can work properly");installing.push(a);console.log(a+": Waiting for dependency installation to complete...");require("child_process").exec("cd "+a+"&&npm i --force "+g[1],m=>{m.stderr?console.log('Error while installing dependency "'+g[1]+'" : '+m.stderr):console.log('Dependency "'+
g[1]+'" installing done!\nRestarting '+a+"...");installedDeps.push(g[1]);newbot(a)})}else console.error(b.toString("utf-8"));installing[npm.installing.findIndex(m=>m==a)]=void 0});c.on("close",l);bots[a]={raw:c,terminate:()=>{bots[a]="Terminated";console.log(a+" have been terminated by user.");kills.push(a);c.kill()},restart:()=>{kills.push(a);c.kill();newbot(a)}};return c}catch(c){console.log("Cannot spawn '"+a+"'"+(process.argv.includes("--debug")?": "+c:"\n  - Run node with --debug to see the detailed error."))}};
(()=>{let a=k.readdirSync(process.cwd(),{withFileTypes:!0}).filter(b=>b.isDirectory()).map(b=>b.name);console.log("MultiBot v"+ver+" initiating...");process.argv.includes("--no_update")?console.log("  - Update checker disabled with --no_update tag."):(checkUpdate(),console.log("  - To disable update check, add --no_update on startup"));0<a.length?console.log("Bots found : "+a.join(", ")):console.log("No bot found.");a.map(newbot);setTimeout(b=>process.stdout.write((0<bots.length?"\n":"")+"MultiBot REPL v"+
ver+"\nhelp() for help\n> "),1E3*bots.length);console.log(process.argv.includes("--no_update")?"Auto update check disabled.":"Auto update will check for update every 5 minutes.");process.argv.includes("--no_update")||setInterval(()=>checkUpdate(!0),3E5);let l=e.start("> "),c={dir:a,bots,npm,ver:"MultiBot v"+ver,spawn:newbot,newbot,help:f,checkUpdate,wexec,...Object.keys(bots).map(b=>g=>bots[b].raw.stdin.write(g))};Object.keys(c).map(b=>l.context[b]=c[b])})()}else{let h=workerData[0],k=workerData[1],
e=workerData[1][0];if(!h)throw Error("Worker name is not specified.");let f={newbotvm:{desc:"run new bot inside Worker's VM",arg_usage:'{[index:"BOT_INDEX",]cwd:"BOT_FOLDER"}',run:()=>{const d=require("vm"),a=require("fs");if(!k[0].cwd)throw Error("CWD not specified");d.runInNewContext(a.readFileSync(k[0].index||"index.js").toString("utf-8").replace(/require\((.*)\)/,"require('"+k[0].index+"'+$1)"),d.createContext({require}));parentPort.postMessage("VM "+k[0].index+" exited.")}},help:{desc:"display this help",
arg_usage:"[cmdname]",run:()=>{!e||Object.keys(f).includes(e)?console.log("MultiBot::v"+ver+"::Worker."+(e?e+".help":"help")+"\n"+(e?` - ${e}\n  - Description :\n${f[e].desc.split("\n").map(d=>">   "+d).join("\n")}\n  - Usage : wexec('${e}')(${f[e].arg_usage})`:Object.keys(f).map(d=>` - ${d}\n  - Description :\n${f[d].desc.split("\n").map(a=>"    | "+a).join("\n")}\n  - Usage : wexec('${d}')(${f[d].arg_usage})`).join("\n"))):console.log("MultiBot::v"+ver+"::Worker."+e+": Not found")}}};if(!Object.keys(f).includes(h))throw Error("Worker "+
h+" not found.");f[h].run(...k)};
